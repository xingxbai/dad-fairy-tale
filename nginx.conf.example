# 建议将此文件复制到 /opt/homebrew/etc/nginx/servers/dad-fairy-tale.conf
# 或者将内容添加到 /opt/homebrew/etc/nginx/nginx.conf 的 http 块中

server {
    listen 8081; # 使用 8081 避免与默认 8080 冲突，如果需要 80 端口请修改（可能需要 sudo）
    server_name localhost;

    # 项目根目录 (用于静态资源)
    root /Users/baixingxing/xingxbai/frontend/2025AI/讲故事/dad-fairy-tale/dist;
    index index.html;

    # 日志
    access_log /opt/homebrew/var/log/nginx/dad-fairy-tale.access.log;
    error_log /opt/homebrew/var/log/nginx/dad-fairy-tale.error.log;

    # 静态资源优化：直接由 Nginx 处理，不经过 Node.js
    location /assets/ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
        # root 指令已在上方定义，此处会继承
    }

    # 其他所有请求（HTML, API, WebSocket）转发给本地 Node.js 服务
    location / {
        proxy_pass http://127.0.0.1:3000;

        # WebSocket 必须的配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 传递头部信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
